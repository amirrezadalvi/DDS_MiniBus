# DDS Mini-Bus

A minimal publish/subscribe bus in C++17 + Qt 6 (MinGW). Features:
- Discovery (broadcast/multicast; loopback for local demos)
- Serialization (JSON/CBOR) with format negotiation
- QoS: reliable (ACK/retry) and best-effort
- UDP (unicast/broadcast/multicast) + TCP transports
- Config-driven runtime
- Tests via CTest/QtTest

## Architecture / معماری
- [Persian Documentation](docs/fa/Architecture.fa.md)
- Diagrams:
  - [Component Diagram](docs/diagrams/component.puml)
  - [Reliable Publish Sequence](docs/diagrams/sequence_publish_reliable.puml)

Diagrams are in PlantUML format. To view them, install the PlantUML extension in VS Code.

## Requirements (Windows)
- Qt 6.9.2 (mingw_64)
- MinGW 13.x (bundled with Qt Tools)
- CMake

> **Note:** On Windows/MinGW, the single-process `test_integration_scenarios` is disabled by default due to known Qt event-loop limitations. All other tests pass. End-to-end behavior is validated via the multi-process demos below. To force-enable it anywhere: set `FORCE_ENABLE_INTEGRATION_TESTS=1`.

## Quick Build (PowerShell)
```powershell
# Ensure tools on PATH (adjust Qt path if needed)
$env:PATH = "C:\Program Files\CMake\bin;C:\Qt\Tools\mingw1310_64\bin;C:\Qt\6.9.2\mingw_64\bin;$env:PATH"
$env:CMAKE_PREFIX_PATH = "C:\Qt\6.9.2\mingw_64\lib\cmake"

# From the repo root:
cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
cmake --build build -- -j
cmake --build build --target qt_deploy_copy_configs
```

## Tests
```powershell
ctest --test-dir build --timeout 120 --output-on-failure -V
```
Expected on Windows: all tests pass; test_integration_scenarios shows Not Run (Disabled).

## Local Demos

### 2-terminal (1 Publisher + 1 Subscriber)
Open two PowerShell terminals, then:

**Terminal #1 (Subscriber)**
```powershell
.\scripts\run_rx.ps1
```

**Terminal #2 (Publisher)**
```powershell
.\scripts\run_tx.ps1
```

You should see on RX: discovery: peer=..., [UDP-IN] len=..., and temperature: {...}.
On TX: [ROUTE] topic=... and [SEND][DONE] mid=....

### 3-terminal (1 Publisher + 2 Subscribers)
```powershell
.\scripts\run_1pub_2subs.ps1
```
TX should show routes to 2 peers; both RX windows should print temperature messages.

### Optional: Real Multicast
If your network/firewall permits:
```powershell
$env:ALLOW_MULTICAST_TESTS = "1"
```
and use the multicast config variant.

## Troubleshooting

Run demos from `build\qt_deploy` (Qt DLLs are deployed here).

Verbose logs:
```powershell
$env:QT_LOGGING_RULES = "dds.disc=true;dds.net=true"
```

Full clean rebuild:
```powershell
if (Test-Path .\build) { Remove-Item -Recurse -Force .\build }
cmake -S . -B build -G "MinGW Makefiles" -DCMAKE_BUILD_TYPE=Release
cmake --build build -- -j
ctest --test-dir build --timeout 120 --output-on-failure -V
```

## Repository Layout
```
config/                 # sample configs
docs/
  Architecture.md
  diagrams/
    component.puml
    sequence_publish_reliable.puml
scripts/
  run_rx.ps1
  run_tx.ps1
  run_1pub_2subs.ps1
src/
tests/
build/                  # generated by CMake (ignored)